---
title: "Distribuci√≥n Binomial Negativa"
lang: es
---

```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(knitr)
library(gridExtra)
library(plotly)
```

La **distribuci√≥n binomial negativa** modela el n√∫mero de fracasos que ocurren antes de obtener exactamente $r$ √©xitos en una secuencia de ensayos independientes de Bernoulli, donde cada ensayo tiene una probabilidad constante $p$ de √©xito.

::: {#def-binom_neg}
Si $X$ es una variable aleatoria que sigue una distribuci√≥n binomial negativa, entonces $X$ representa el n√∫mero de fracasos antes de obtener el $r$-√©simo √©xito. La funci√≥n probabilidad est√° dada por:

$$f(x) = \binom{r + x - 1}{x} p^r (1-p)^x$$

donde $x = 0, 1, 2, 3, \ldots$ representa el n√∫mero de fracasos. Una variable aleatoria con esta distribuci√≥n se denota como: $X \sim \text{BinNeg}(r, p)$
:::

## Caracter√≠sticas

**Par√°metros**

La distribuci√≥n binomial negativa tiene dos par√°metros:

-   $r$: N√∫mero de √©xitos deseados (entero positivo, $r \geq 1$)
-   $p$: Probabilidad de √©xito en cada ensayo ($0 < p \leq 1$)

**Par√°metros Estad√≠sticos**

Media (Esperanza):

$$E(X) = \frac{r(1-p)}{p}$$

Varianza:

$$\text{Var}(X) = \frac{r(1-p)}{p^2}$$

Desviaci√≥n est√°ndar:

$$\sigma = \sqrt{\frac{r(1-p)}{p^2}}$$

**Funci√≥n de Distribuci√≥n (Probabilidad Acumulada):**

$$F(x) = P(X \leq x) = \sum_{i=0}^{x} \binom{r + i - 1}{i} p^r (1-p)^i$$

## Ejemplo B√°sico

Un estudiante est√° practicando tiros libres de baloncesto. Su probabilidad de anotar es $p = 0.6$. ¬øCu√°l es la probabilidad de que falle exactamente 3 tiros antes de anotar su segundo tiro libre?

**Par√°metros:**

-   $r = 2$ (queremos el segundo √©xito)
-   $p = 0.6$ (probabilidad de √©xito)
-   $k = 3$ (n√∫mero de fracasos)

**C√°lculo:**

```{r ejemplo-basico}
# Par√°metros
r <- 2
p <- 0.6
k <- 3

# C√°lculo de la probabilidad
prob <- choose(k + r - 1, k) * (p^r) * ((1-p)^k)
cat("P(X = 3) =", round(prob, 4))

# Verificaci√≥n usando R
prob_r <- dnbinom(k, size = r, prob = p)
cat("\nVerificaci√≥n con R:", round(prob_r, 4))
```

**Interpretaci√≥n:** La probabilidad de fallar exactamente 3 tiros antes de anotar el segundo tiro libre es aproximadamente `r round(prob, 4)`.

**Par√°metros estad√≠sticos del ejemplo**

```{r parametros-ejemplo}
# Media
media <- r * (1 - p) / p
cat("Media:", round(media, 4))

# Varianza
varianza <- r * (1 - p) / (p^2)
cat("\nVarianza:", round(varianza, 4))

# Desviaci√≥n est√°ndar
desv_std <- sqrt(varianza)
cat("\nDesviaci√≥n est√°ndar:", round(desv_std, 4))
```

## Comparaci√≥n: Efecto de los Par√°metros

### Efecto del par√°metro $r$ (n√∫mero de √©xitos)

```{r efecto-r, fig.cap="Efecto del par√°metro r en la distribuci√≥n binomial negativa"}
# Valores de k para graficar
k_vals <- 0:20

# Diferentes valores de r, p fijo
r_values <- c(1, 2, 5, 10)
p_fixed <- 0.4

# Crear data frame para ggplot
data_r <- expand.grid(k = k_vals, r = r_values)
data_r$p <- p_fixed
data_r$prob <- dnbinom(data_r$k, size = data_r$r, prob = data_r$p)
data_r$r <- factor(data_r$r, labels = paste("r =", r_values))

# Gr√°fico
plot_r <- ggplot(data_r, aes(x = k, y = prob, fill = r)) +
  geom_col(position = "dodge", alpha = 0.7) +
  scale_x_continuous(breaks = k_vals) +
  labs(title = "Efecto del par√°metro r (p = 0.4 fijo)",
       x = "N√∫mero de fracasos (k)",
       y = "Probabilidad",
       fill = "Par√°metro r") +
  theme_minimal() +
  scale_fill_brewer(type = "qual", palette = "Set1")

ggplotly(plot_r)
```

### Efecto del par√°metro $p$ (probabilidad de √©xito)

```{r efecto-p, fig.cap="Efecto del par√°metro p en la distribuci√≥n binomial negativa"}
# Diferentes valores de p, r fijo
p_values <- c(0.2, 0.4, 0.6, 0.8)
r_fixed <- 3

# Crear data frame para ggplot
data_p <- expand.grid(k = k_vals, p = p_values)
data_p$r <- r_fixed
data_p$prob <- dnbinom(data_p$k, size = data_p$r, prob = data_p$p)
data_p$p <- factor(data_p$p, labels = paste("p =", p_values))

# Gr√°fico
plot_p <- ggplot(data_p, aes(x = k, y = prob, fill = p)) +
  geom_col(position = "dodge", alpha = 0.7) +
  scale_x_continuous(breaks = k_vals) +
  labs(title = "Efecto del par√°metro p (r = 3 fijo)",
       x = "N√∫mero de fracasos (k)",
       y = "Probabilidad",
       fill = "Par√°metro p") +
  theme_minimal() +
  scale_fill_brewer(type = "qual", palette = "Set2")

 ggplotly(plot_p)
```

### Tabla comparativa de par√°metros estad√≠sticos

```{r tabla-comparativa}
# Crear tabla con diferentes combinaciones de par√°metros
combinaciones <- expand.grid(
  r = c(2, 5, 10),
  p = c(0.3, 0.5, 0.7)
)

combinaciones$Media <- combinaciones$r * (1 - combinaciones$p) / combinaciones$p
combinaciones$Varianza <- combinaciones$r * (1 - combinaciones$p) / (combinaciones$p^2)
combinaciones$Desv_Std <- sqrt(combinaciones$Varianza)

# Redondear para mejor presentaci√≥n
combinaciones[3:5] <- round(combinaciones[3:5], 3)

kable(combinaciones, 
      caption = "Par√°metros estad√≠sticos para diferentes valores de r y p",
      col.names = c("r", "p", "Media", "Varianza", "Desv. Est√°ndar"))
```

### Observaciones sobre el efecto de los par√°metros

**Efecto de** $r$:

-   Al aumentar $r$, la distribuci√≥n se desplaza hacia la derecha (mayor media)
-   La variabilidad tambi√©n aumenta
-   Para $r = 1$, se obtiene la distribuci√≥n geom√©trica

**Efecto de** $p$:

-   Al aumentar $p$ (mayor probabilidad de √©xito), la distribuci√≥n se concentra m√°s cerca de cero
-   La media y varianza disminuyen cuando $p$ aumenta

## Simulaci√≥n de Valores y Comparaci√≥n con la Te√≥rica

Consideremos una variable aleatoria $X \sim \text{BinNeg}(r=5, p=0.3)$. Simularemos 10,000 valores y compararemos las estad√≠sticas obtenidas con las te√≥ricas.

```{r simulacion-basica}
# Par√°metros para la simulaci√≥n
r <- 5
p <- 0.3
n_sim <- 10000

# Simulaci√≥n de valores
set.seed(422)
valores_simulados <- rnbinom(n_sim, size = r, prob = p)

# Estad√≠sticas de la simulaci√≥n
media_sim <- mean(valores_simulados)
var_sim <- var(valores_simulados)
sd_sim <- sd(valores_simulados)

# Valores te√≥ricos
media_teorica <- r * (1 - p) / p
var_teorica <- r * (1 - p) / (p^2)
sd_teorica <- sqrt(var_teorica)

# Tabla comparativa
comparacion <- data.frame(
  Estad√≠stica = c("Media", "Varianza", "Desv. Est√°ndar"),
  Te√≥rica = c(media_teorica, var_teorica, sd_teorica),
  Simulada = c(media_sim, var_sim, sd_sim),
  Diferencia = c(abs(media_teorica - media_sim), 
                 abs(var_teorica - var_sim), 
                 abs(sd_teorica - sd_sim))
)

kable(comparacion, digits = 4, 
      caption = paste("Comparaci√≥n te√≥rica vs simulada (r =", r, ", p =", p, ")"))
```

**Visualizaci√≥n**

```{r grafico-comparacion, fig.cap="Comparaci√≥n entre distribuci√≥n te√≥rica y simulada"}
# Rango de valores para comparar
k_max <- quantile(valores_simulados, 0.99)
k_vals <- 0:k_max

# Probabilidades te√≥ricas
prob_teorica <- dnbinom(k_vals, size = r, prob = p)

# Frecuencias relativas de la simulaci√≥n
freq_simulada <- table(factor(valores_simulados, levels = k_vals))
freq_relativa <- as.numeric(freq_simulada) / n_sim

# Crear data frame para ggplot
data_comp <- data.frame(
  k = rep(k_vals, 2),
  Probabilidad = c(prob_teorica, freq_relativa),
  Tipo = rep(c("Te√≥rica", "Simulada"), each = length(k_vals))
)

# Gr√°fico de barras comparativo
ggplot(data_comp, aes(x = k, y = Probabilidad, fill = Tipo)) +
  geom_col(position = "dodge", alpha = 0.7, width = 0.8) +
  labs(title = paste("Distribuci√≥n Binomial Negativa: Te√≥rica vs Simulada"),
       subtitle = paste("r =", r, ", p =", p, ", n =", format(n_sim, big.mark = ",")),
       x = "N√∫mero de fracasos (k)",
       y = "Probabilidad / Frecuencia relativa",
       fill = "Distribuci√≥n") +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_fill_manual(values = c("Te√≥rica" = "#2E86C1", "Simulada" = "#E74C3C")) 
```

**Convergencia de la Simulaci√≥n**

```{r convergencia, fig.cap="Convergencia de la media simulada hacia la te√≥rica"}
# Diferentes tama√±os de muestra
tama√±os <- seq(100, 10000, by = 100)
medias_acumuladas <- sapply(tama√±os, function(n) mean(valores_simulados[1:n]))

# Data frame para el gr√°fico
data_conv <- data.frame(
  n = tama√±os,
  Media_simulada = medias_acumuladas,
  Media_teorica = media_teorica
)

# Gr√°fico de convergencia
ggplot(data_conv) +
  geom_line(aes(x = n, y = Media_simulada), color = "#E74C3C", linewidth = 1) +
  geom_hline(yintercept = media_teorica, color = "#2E86C1", 
             linetype = "dashed", linewidth = 1.2) +
  labs(title = "Convergencia de la Media Simulada",
       subtitle = paste("L√≠nea azul: Media te√≥rica =", round(media_teorica, 3)),
       x = "Tama√±o de muestra",
       y = "Media") +
  theme_minimal() +
  annotate("text", x = 7500, y = media_teorica + 0.3, 
           label = paste("Media te√≥rica:", round(media_teorica, 3)), 
           color = "#2E86C1")
```

## Comparaci√≥n entre Binomial Negativa y Geom√©trica

### Relaci√≥n Te√≥rica

La distribuci√≥n geom√©trica es un caso especial de la binomial negativa cuando $r = 1$. Ambas modelan el n√∫mero de fracasos antes de obtener √©xitos, pero:

-   **Geom√©trica:** N√∫mero de fracasos antes del **primer** √©xito
-   **Binomial Negativa:** N√∫mero de fracasos antes del **r-√©simo** √©xito

### Comparaci√≥n Matem√°tica

```{r comparacion-matematica}
# Par√°metros
p_comp <- 0.4
r_values <- c(1, 2, 5, 10)  # r = 1 corresponde a la geom√©trica

# Calcular par√°metros estad√≠sticos
comp_params <- data.frame(
  r = r_values,
  Media = r_values * (1 - p_comp) / p_comp,
  Varianza = r_values * (1 - p_comp) / (p_comp^2),
  Desv_Std = sqrt(r_values * (1 - p_comp) / (p_comp^2))
)

comp_params$Es_Geometrica <- ifelse(comp_params$r == 1, "S√≠", "No")

kable(comp_params, digits = 3,
      caption = paste("Par√°metros estad√≠sticos para diferentes valores de r (p =", p_comp, ")"),
      col.names = c("r", "Media", "Varianza", "Desv. Est√°ndar", "¬øGeom√©trica?"))
```

### Comparaci√≥n Gr√°fica

```{r grafico-geometrica-vs-binomial, fig.cap="Comparaci√≥n entre distribuci√≥n geom√©trica y binomial negativa"}
# Valores de k para graficar
k_vals <- 0:15

# Crear data frame con las distribuciones
data_dist <- expand.grid(k = k_vals, r = c(1, 2, 3, 5))
data_dist$p <- p_comp
data_dist$Probabilidad <- dnbinom(data_dist$k, size = data_dist$r, prob = data_dist$p)
data_dist$Distribucion <- ifelse(data_dist$r == 1, "Geom√©trica (r=1)", 
                                paste("Binomial Neg. (r=", data_dist$r, ")", sep=""))

# Gr√°fico
ggplot(data_dist, aes(x = k, y = Probabilidad, fill = Distribucion)) +
  geom_col(alpha = 0.7) +
  facet_wrap(~Distribucion, scales = "free_y") +
  labs(title = "Comparaci√≥n: Geom√©trica vs Binomial Negativa",
       subtitle = paste("p =", p_comp),
       x = "N√∫mero de fracasos (k)",
       y = "Probabilidad") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(type = "qual", palette = "Set3")
```

### Verificaci√≥n mediante Simulaci√≥n

```{r simulacion-comparacion}
n_sim_comp <- 5000
p_sim <- 0.35

# Simulaci√≥n de geom√©trica (r = 1)
geometrica_sim <- rnbinom(n_sim_comp, size = 1, prob = p_sim)

# Simulaci√≥n de binomial negativa (r = 3)
binneg_sim <- rnbinom(n_sim_comp, size = 3, prob = p_sim)

# Estad√≠sticas simuladas
stats_sim <- data.frame(
  Distribuci√≥n = c("Geom√©trica (r=1)", "Binomial Neg. (r=3)"),
  Media_Simulada = c(mean(geometrica_sim), mean(binneg_sim)),
  Media_Te√≥rica = c(1 * (1-p_sim)/p_sim, 3 * (1-p_sim)/p_sim),
  Var_Simulada = c(var(geometrica_sim), var(binneg_sim)),
  Var_Te√≥rica = c(1 * (1-p_sim)/(p_sim^2), 3 * (1-p_sim)/(p_sim^2))
)

kable(stats_sim, digits = 3,
      caption = paste("Verificaci√≥n por simulaci√≥n (p =", p_sim, ", n =", 
                      format(n_sim_comp, big.mark = ","), ")"))
```

```{r histogramas-comparacion, fig.cap="Histogramas comparativos de las simulaciones"}
# Combinar datos para el gr√°fico
data_hist <- data.frame(
  valores = c(geometrica_sim, binneg_sim),
  distribucion = rep(c("Geom√©trica (r=1)", "Binomial Negativa (r=3)"), 
                     each = n_sim_comp)
)

# Histogramas comparativos
ggplot(data_hist, aes(x = valores, fill = distribucion)) +
  geom_histogram(alpha = 0.7, bins = 20, position = "identity") +
  facet_wrap(~distribucion, scales = "free") +
  labs(title = "Histogramas de las Simulaciones",
       subtitle = paste("p =", p_sim, ", n =", format(n_sim_comp, big.mark = ",")),
       x = "N√∫mero de fracasos",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#3498DB", "#E67E22"))
```

## Aproximaci√≥n con el Teorema Central del L√≠mite

### Fundamento Te√≥rico

Cuando $r$ es grande, la distribuci√≥n binomial negativa se puede aproximar a una distribuci√≥n normal:

$$X \sim \text{BinNeg}(r, p) \approx N\left(\mu = \frac{r(1-p)}{p}, \sigma^2 = \frac{r(1-p)}{p^2}\right)$$

### Demostraci√≥n con Simulaci√≥n

```{r tcl-demostracion, fig.cap="Aproximaci√≥n normal para diferentes valores de r"}
# Par√°metros para TCL
p_tcl <- 0.3
r_vals_tcl <- c(5, 10, 20, 50)
n_sim_tcl <- 5000

# Funci√≥n para crear datos de comparaci√≥n
crear_datos_tcl <- function(r_val, p_val, n_sim) {
  # Simulaci√≥n
  sim_vals <- rnbinom(n_sim, size = r_val, prob = p_val)
  
  # Par√°metros te√≥ricos
  mu <- r_val * (1 - p_val) / p_val
  sigma2 <- r_val * (1 - p_val) / (p_val^2)
  sigma <- sqrt(sigma2)
  
  # Normalizar
  z_vals <- (sim_vals - mu) / sigma
  
  return(list(
    originales = sim_vals,
    normalizados = z_vals,
    mu = mu,
    sigma = sigma,
    r = r_val
  ))
}

# Generar datos para cada r
datos_tcl <- lapply(r_vals_tcl, crear_datos_tcl, p_val = p_tcl, n_sim = n_sim_tcl)

# Crear data frame para ggplot
data_tcl <- do.call(rbind, lapply(1:length(datos_tcl), function(i) {
  data.frame(
    valores_norm = datos_tcl[[i]]$normalizados,
    r_valor = paste("r =", datos_tcl[[i]]$r)
  )
}))

# Gr√°fico de densidad con aproximaci√≥n normal
ggplot(data_tcl, aes(x = valores_norm)) +
  geom_histogram(aes(y = after_stat(density)), alpha = 0.6, bins = 30, fill = "#3498DB") +
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), 
                color = "#E74C3C", linewidth = 1.2, linetype = "dashed") +
  facet_wrap(~r_valor, scales = "free") +
  labs(title = "Aproximaci√≥n Normal (Teorema Central del L√≠mite)",
       subtitle = paste("Valores normalizados, p =", p_tcl, 
                       ". L√≠nea roja: N(0,1)"),
       x = "Valores normalizados (Z)",
       y = "Densidad") +
  theme_minimal()
```

## Relaci√≥n con la Suma de Variables Geom√©tricas

::: {#prp-binneg_geo}
Si $X_1, X_2, \ldots, X_r$ son variables aleatorias independientes e id√©nticamente distribuidas con distribuci√≥n geom√©trica de par√°metro $p$ (n√∫mero de fracasos antes del primer √©xito), entonces:

$$Y = X_1 + X_2 + \cdots + X_r \sim \text{BinNeg}(r, p)$$

Es decir, la suma de $r$ variables aleatorias geom√©tricas independientes sigue una distribuci√≥n binomial negativa con par√°metros $r$ y $p$.
:::

**Justificaci√≥n intuitiva**

-   Cada $X_i$ cuenta los fracasos antes del $i$-√©simo √©xito
-   $Y = \sum_{i=1}^r X_i$ cuenta el total de fracasos antes de obtener $r$ √©xitos
-   Esto es exactamente lo que modela la distribuci√≥n binomial negativa

### Verificaci√≥n por Simulaci√≥n

```{r simulacion-proposicion}
# Par√°metros
r <- 4
p <- 0.3
n_sim <- 10000

set.seed(42)

# M√©todo 1: Generar r variables geom√©tricas y sumarlas
suma_geometricas <- replicate(n_sim, {
  geometricas <- rgeom(r, prob = p)  # rgeom en R usa la definici√≥n est√°ndar
  sum(geometricas)
})

# M√©todo 2: Generar directamente de binomial negativa
binomial_negativa <- rnbinom(n_sim, size = r, prob = p)

# Comparar estad√≠sticas
stats_comparacion <- data.frame(
  M√©todo = c("Suma de Geom√©tricas", "Binomial Negativa Directa"),
  Media = c(mean(suma_geometricas), mean(binomial_negativa)),
  Varianza = c(var(suma_geometricas), var(binomial_negativa)),
  Desv_Std = c(sd(suma_geometricas), sd(binomial_negativa)),
  Min = c(min(suma_geometricas), min(binomial_negativa)),
  Max = c(max(suma_geometricas), max(binomial_negativa))
)

# Valores te√≥ricos
media_teorica <- r * (1 - p) / p
var_teorica <- r * (1 - p) / (p^2)

stats_comparacion$Dif_Media_Teorica <- abs(stats_comparacion$Media - media_teorica)
stats_comparacion$Dif_Var_Teorica <- abs(stats_comparacion$Varianza - var_teorica)

kable(stats_comparacion, digits = 4,
      caption = paste("Verificaci√≥n de la proposici√≥n (r =", r, ", p =", p, ")"))

cat("Valores te√≥ricos:\n")
cat("Media:", round(media_teorica, 4), "\n")
cat("Varianza:", round(var_teorica, 4), "\n")
```

```{r comparacion-distribuciones, fig.cap="Comparaci√≥n de histogramas: Suma de geom√©tricas vs Binomial negativa"}
# Crear data frame para comparaci√≥n
data_comparacion <- data.frame(
  valores = c(suma_geometricas, binomial_negativa),
  metodo = rep(c("Suma de r=4 Geom√©tricas", "Binomial Negativa (r=4)"), 
               each = n_sim)
)

# Histogramas comparativos
ggplot(data_comparacion, aes(x = valores, fill = metodo)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  facet_wrap(~metodo, ncol = 1) +
  labs(title = "Verificaci√≥n de la Proposici√≥n: Suma de Geom√©tricas = Binomial Negativa",
       subtitle = paste("r =", r, ", p =", p, ", n =", format(n_sim, big.mark = ",")),
       x = "N√∫mero de fracasos",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#3498DB", "#E74C3C"))
```

## Ejemplos Pr√°cticos

::: {#exm-calidadbinneg}
### Control de Calidad en Producci√≥n

**Situaci√≥n:** Una f√°brica produce componentes electr√≥nicos. La probabilidad de que un componente sea defectuoso es $p = 0.15$. Un inspector necesita encontrar 3 componentes buenos para completar un lote.

**Pregunta:** ¬øCu√°l es la probabilidad de que el inspector examine exactamente 8 componentes defectuosos antes de encontrar los 3 buenos?

```{r ejemplo-calidad}
# Par√°metros del problema
p_bueno <- 0.85  # Probabilidad de componente bueno
r_buenos <- 3    # Componentes buenos necesarios
k_defectuosos <- 8  # Componentes defectuosos observados

# M√©todo 1: Usando binomial negativa directamente
prob_binneg <- dnbinom(k_defectuosos, size = r_buenos, prob = p_bueno)

# M√©todo 2: Simulaci√≥n como suma de geom√©tricas
# Cada geom√©trica cuenta defectuosos antes de cada componente bueno
n_sim_ej1 <- 100000
suma_defectuosos <- replicate(n_sim_ej1, {
  sum(rgeom(r_buenos, prob = p_bueno))
})

prob_simulada <- mean(suma_defectuosos == k_defectuosos)

cat("EJEMPLO 1: Control de Calidad\n")
cat("=============================\n")
cat("Probabilidad (f√≥rmula):", round(prob_binneg, 6), "\n")
cat("Probabilidad (simulaci√≥n):", round(prob_simulada, 6), "\n")
cat("Diferencia:", abs(prob_binneg - prob_simulada), "\n\n")

# Interpretaci√≥n pr√°ctica
cat("Interpretaci√≥n: La probabilidad de examinar exactamente 8 componentes\n")
cat("defectuosos antes de encontrar 3 buenos es aproximadamente", 
    round(prob_binneg * 100, 2), "%\n")
```
:::

::: {#exm-ventas_prosp}
**Situaci√≥n:** Un vendedor tiene una tasa de √©xito del 25% en sus presentaciones. Necesita cerrar 5 ventas para cumplir su meta mensual.

**Preguntas:** 1. ¬øCu√°l es el n√∫mero esperado de rechazos antes de cerrar 5 ventas? 2. ¬øCu√°l es la probabilidad de tener entre 10 y 15 rechazos?

```{r ejemplo-ventas}
# Par√°metros
p_exito <- 0.25
r_ventas <- 5

# 1. N√∫mero esperado de rechazos
rechazos_esperados <- r_ventas * (1 - p_exito) / p_exito
desv_std_rechazos <- sqrt(r_ventas * (1 - p_exito) / (p_exito^2))

# 2. Probabilidad entre 10 y 15 rechazos
prob_10_15 <- sum(dnbinom(10:15, size = r_ventas, prob = p_exito))

# Simulaci√≥n para verificar
n_sim_ej2 <- 50000
simulacion_ventas <- replicate(n_sim_ej2, {
  sum(rgeom(r_ventas, prob = p_exito))
})

rechazos_sim_esperados <- mean(simulacion_ventas)
prob_10_15_sim <- mean(simulacion_ventas >= 10 & simulacion_ventas <= 15)

cat("EJEMPLO 2: Ventas y Prospecci√≥n\n")
cat("================================\n")
cat("1. Rechazos esperados:\n")
cat("   Te√≥rico:", round(rechazos_esperados, 2), "¬±", round(desv_std_rechazos, 2), "\n")
cat("   Simulaci√≥n:", round(rechazos_sim_esperados, 2), "\n\n")

cat("2. P(10 ‚â§ rechazos ‚â§ 15):\n")
cat("   Te√≥rico:", round(prob_10_15, 4), "\n")
cat("   Simulaci√≥n:", round(prob_10_15_sim, 4), "\n")
```
:::

::: {#exm-algoritmo}
**Situaci√≥n:** Un algoritmo de machine learning busca patrones espec√≠ficos en datos. La probabilidad de encontrar un patr√≥n v√°lido es 0.4. El algoritmo necesita encontrar 6 patrones para entrenar el modelo.

```{r ejemplo-ml, fig.cap="Distribuci√≥n de iteraciones fallidas en machine learning"}
# Par√°metros
p_patron <- 0.4
r_patrones <- 6

# Simulaci√≥n del proceso
n_experimentos <- 10000
iteraciones_fallidas <- replicate(n_experimentos, {
  sum(rgeom(r_patrones, prob = p_patron))
})

# Estad√≠sticas
media_iteraciones <- mean(iteraciones_fallidas)
percentiles <- quantile(iteraciones_fallidas, probs = c(0.25, 0.5, 0.75, 0.9, 0.95))

cat("EJEMPLO 3: Machine Learning\n")
cat("===========================\n")
cat("Iteraciones fallidas esperadas:", round(media_iteraciones, 1), "\n")
cat("Percentiles:\n")
print(round(percentiles, 1))

# Gr√°fico de la distribuci√≥n
ggplot(data.frame(iteraciones = iteraciones_fallidas), aes(x = iteraciones)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "#3498DB", alpha = 0.7) +
  geom_vline(xintercept = media_iteraciones, color = "#E74C3C", 
             linetype = "dashed", linewidth = 1) +
  labs(title = "Distribuci√≥n de Iteraciones Fallidas en ML",
       subtitle = paste("p =", p_patron, ", r =", r_patrones, 
                       ". L√≠nea roja: media =", round(media_iteraciones, 1)),
       x = "N√∫mero de iteraciones fallidas",
       y = "Densidad") +
  theme_minimal()
```
:::

## Ejercicios Propuestos

::: {#exr-grafico}
Implemente una funci√≥n que tome como par√°metros $(r, p, n_{sim})$ y devuelva un gr√°fico comparativo entre la suma de geom√©tricas y la binomial negativa.

```{r}
comparar_distribuciones <- function(r = 4, p = 0.3, n_sim = 1000) {
  
  # Simulaciones
  suma_geom <- replicate(n_sim, sum(rgeom(r, prob = p)))
  bin_neg <- rnbinom(n_sim, size = r, prob = p)
  
  # Preparar datos
  df <- data.frame(
    resultado = c(suma_geom, bin_neg),
    tipo = factor(rep(c("Suma Geom√©tricas", "Binomial Negativa"), each = n_sim))
  )
  
  # Gr√°fico con estilo diferente
  ggplot(df, aes(x = resultado, fill = tipo)) +
    geom_density(alpha = 0.6) +
    labs(
      title = "Comparaci√≥n de distribuciones simuladas",
      subtitle = paste0("Par√°metros: r = ", r, ", p = ", p, ", simulaciones = ", format(n_sim, big.mark = ",")),
      x = "N√∫mero de fracasos",
      y = "Densidad"
    ) +
    theme_classic() +
    scale_fill_manual(values = c("lightgreen", "lightblue")) +
    theme(
      legend.title = element_blank(),
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 10)
    )
}

# Ejemplo de uso
comparar_distribuciones(r = 3, p = 0.4, n_sim = 1000)

```
:::

::: {#exr-baloncesto}
Un jugador de baloncesto tiene 70% de efectividad en tiros libres. En una sesi√≥n de entrenamiento quiere anotar 8 tiros libres consecutivos exitosos.

a)  Modele el problema usando la proposici√≥n de suma de geom√©tricas

    ```{r}
    #| code-fold: true

    # Par√°metros
    p_tiro <- 0.70           # Probabilidad de anotar
    r_tiros <- 8             # N√∫mero de aciertos deseados
    n_sim_baloncesto <- 1000 # N√∫mero de sesiones simuladas

    # Modelar con suma de geom√©tricas
    ## Cada geom√©trica cuenta los tiros fallados antes de cada tiro exitoso
    ## La suma total representa los fallos antes de lograr 8 aciertos

    ```

b)  Calcule el n√∫mero esperado de tiros fallados

    ```{r}
    esperado_fallados <- r_tiros * (1 - p_tiro) / p_tiro
    desv_std_fallados <- sqrt(r_tiros * (1 - p_tiro) / (p_tiro^2))

    cat("N√∫mero esperado de tiros fallados:", round(esperado_fallados, 2), "¬±", round(desv_std_fallados, 2), "\n\n")
     
    ```

c)  Simule 1000 sesiones de entrenamiento y compare con el valor te√≥rico

    ```{r}
    set.seed(123)
    simulacion_baloncesto <- replicate(n_sim_baloncesto, {
      sum(rgeom(r_tiros, prob = p_tiro))
    })

    media_sim_baloncesto <- mean(simulacion_baloncesto)

    cat("Media simulada de tiros fallados en", n_sim_baloncesto, "sesiones:", round(media_sim_baloncesto, 2), "\n")
    cat("   Diferencia con el valor te√≥rico:", round(abs(esperado_fallados - media_sim_baloncesto), 4), "\n")

    # Gr√°fico de la distribuci√≥n 
    library(ggplot2)

    ggplot(data.frame(fallados = simulacion_baloncesto), aes(x = fallados)) +
      geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "purple", alpha = 0.7) +
      geom_vline(xintercept = esperado_fallados, color = "blue", 
                 linetype = "dashed", linewidth = 1) +
      labs(
        title = "Distribuci√≥n de Tiros Fallados en Sesiones de Entrenamiento",
        subtitle = paste("p =", p_tiro, ", r =", r_tiros, 
                         ". L√≠nea roja: esperado =", round(esperado_fallados, 2)),
        x = "N√∫mero de tiros fallados",
        y = "Densidad"
      ) +
      theme_minimal()

    ```
:::

::: {#exr-biotecnologia}
Un laboratorio est√° desarrollando un nuevo medicamento. Las pruebas tienen 30% de probabilidad de ser exitosas. Necesitan 4 pruebas exitosas para continuar con la siguiente fase.

a)  ¬øCu√°l es la probabilidad de tener exactamente 12 pruebas fallidas?

b)  ¬øCu√°l es la probabilidad de necesitar m√°s de 20 pruebas fallidas?

c)  Si el costo de cada prueba es \$10,000, ¬øcu√°l es el costo esperado en pruebas fallidas?

    ```{r}
    #| code-fold: true

    # Par√°metros del experimento
    r <- 4                     # N√∫mero de √©xitos requeridos
    p <- 0.30                  # Probabilidad de √©xito por prueba
    k <- 12                    # N√∫mero espec√≠fico de fallos
    n_sim <- 10000            # N√∫mero de simulaciones
    costo_prueba <- 10000     # Costo por prueba

    # a) Probabilidad de tener exactamente 12 pruebas fallidas
    prob_exacto_12 <- dnbinom(k, size = r, prob = p)

    # b) Probabilidad de necesitar m√°s de 20 pruebas fallidas
    prob_mas_20 <- 1 - pnbinom(20, size = r, prob = p)

    # c) Costo esperado en pruebas fallidas (valor te√≥rico)
    esperado_fallidas <- r * (1 - p) / p
    costo_esperado <- esperado_fallidas * costo_prueba

    # Simulaci√≥n
    set.seed(123)
    fallos_simulados <- replicate(n_sim, sum(rgeom(r, prob = p)))
    media_simulada <- mean(fallos_simulados)
    costo_simulado <- media_simulada * costo_prueba

    # Resultados
    cat("üî¨ EJERCICIO: Desarrollo de medicamento\n")
    cat("a) P(X = 12) =", round(prob_exacto_12, 6), "\n")
    cat("b) P(X > 20) =", round(prob_mas_20, 6), "\n")
    cat("c) Costo esperado (te√≥rico): $", round(costo_esperado, 2), "\n")
    cat("d) Costo promedio (simulado): $", round(costo_simulado, 2), "\n")
    cat("e) Diferencia en fallos:", round(abs(esperado_fallidas - media_simulada), 4), "\n\n")

    # Gr√°fico de barras de la simulaci√≥n
    library(ggplot2)
    ggplot(data.frame(Fallos = fallos_simulados), aes(x = Fallos)) +
      geom_bar(fill = "lightblue", alpha = 0.7) +
      geom_vline(xintercept = esperado_fallidas, color = "purple", linetype = "dashed", linewidth = 1) +
      labs(
        title = "Frecuencia de pruebas fallidas simuladas",
        subtitle = paste("Rojo: media te√≥rica =", round(esperado_fallidas, 2)),
        x = "N√∫mero de pruebas fallidas",
        y = "Frecuencia"
      ) +
      theme_minimal()

    ```
:::
